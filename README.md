# test_key_switch_m5stack

M5StackをBluetooth Low Energy (BLE) キーボードとして動作させるファームウェアです。

## 機能

- **Aボタン**: "A" を入力
- **Bボタン**: ":D" を入力  
- **Cボタン**: "Hello!" を入力

## 必要なもの

- M5Stack Core (ESP32)
- PlatformIO環境
- BLE対応のデバイス (PC、スマートフォン、タブレットなど)

## セットアップ

### 1. ファームウェアのビルドとアップロード

```bash
# ビルド
/usr/bin/python3 -m platformio run

# アップロード (M5StackをUSBで接続してから)
/usr/bin/python3 -m platformio run --target upload
```

### 2. BLE接続

1. M5Stackの電源を入れる
2. 画面に "BLE Keyboard" と表示され、"Ready!" が表示されるまで待つ
3. 接続したいデバイス（PC/スマホ等）でBluetooth設定を開く
4. "M5Stack Keyboard" を検索して接続する
5. M5Stackの画面下部に "BLE Connected" と緑色で表示されれば接続完了

## 使用方法

BLE接続が完了したら：

- **Aボタン（左）**: "A" が入力される
- **Bボタン（中央）**: ":D" が入力される  
- **Cボタン（右）**: "Hello!" が入力される

各ボタンを押すと、M5Stackの画面に視覚的なフィードバックが表示されます。

## 技術仕様

- **プラットフォーム**: ESP32 (M5Stack Core)
- **通信方式**: Bluetooth Low Energy (BLE)
- **ライブラリ**: 
  - M5Stack@^0.4.6
  - ESP32 BLE Keyboard@^0.3.2

## 注意事項

- ESP32はUSB HIDキーボードとしては動作できないため、BLEキーボードとして実装しています
- 一度に複数のデバイスには接続できません
- バッテリー駆動時間は使用頻度により変動します

## 絵文字入力の制限について

**問題**: ESP32 BLE Keyboardライブラリは絵文字（マルチバイトUTF-8文字）を正しく処理できません。

**現象**:
- `bleKeyboard.print("😆");` → 接続先デバイスで "tm" と表示される
- `bleKeyboard.print("🍭✒");` → 接続先デバイスで "tb82qg" と表示される

**原因**: 
- BLE HIDプロトコルでは、絵文字のようなマルチバイト文字を直接送信することができません
- ESP32 BLE Keyboardライブラリが絵文字のUTF-8エンコーディングを正しく処理していません

**対策**:
- 絵文字の代わりにASCII文字で代替（例: ":D", "Hello!"）
- より高度な実装では、絵文字入力用のキーボードショートカットを送信する方法もあります

**将来の改善案**:
- キーボードショートカット（Ctrl+;など）を送信して絵文字パネルを開く
- 特定のアプリケーション向けのショートカットを実装する

## トラブルシューティング

### BLE接続できない場合
1. M5Stackを再起動する
2. 接続先デバイスのBluetooth設定をリセットする
3. 他のBLEデバイスとの干渉がないか確認する

### 文字が入力されない場合
1. BLE接続状態を確認する（画面下部の表示）
2. 接続先デバイスでキーボード入力が有効になっているか確認する
3. テキスト入力可能なアプリケーションで試す

## ライセンス

このプロジェクトはオープンソースです。自由に改変・配布してください。
