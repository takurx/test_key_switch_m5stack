# M5Stack S3 USB HID Keyboard ファームウェア

M5Stack CoreS3をUSB HIDキーボードとして動作させるファームウェアです。絵文字などのマルチバイト文字にも対応しています。

## 機能

- **タッチエリアA** (画面左下): "A" を入力
- **タッチエリアB** (画面中央下): "😆" (笑顔の絵文字) を入力  
- **タッチエリアC** (画面右下): "🍭✒" (キャンディとペンの絵文字) を入力

## 必要なもの

- M5Stack CoreS3 (ESP32-S3)
- PlatformIO環境
- USBケーブル（Type-C）

## 技術的な優位性

M5Stack CoreS3（ESP32-S3）は、従来のESP32と異なり、ネイティブUSB HID機能をサポートしています：

- **USB HID対応**: 直接USBキーボードとして認識される
- **マルチバイト文字対応**: 絵文字やUnicode文字を正しく処理可能
- **低遅延**: BLEと比較して応答性が向上
- **安定した接続**: 有線接続による信頼性の高い通信

## セットアップ

### 1. ファームウェアのビルドとアップロード

```bash
# S3プロジェクトディレクトリに移動
cd test_key_switch_m5stack_s3

# ビルド
/usr/bin/python3 -m platformio run

# アップロード (M5Stack S3をUSBで接続してから)
/usr/bin/python3 -m platformio run --target upload
```

### 2. USB HID接続

1. M5Stack S3をUSBケーブルでPCに接続
2. ファームウェアをアップロード後、自動的にUSBキーボードとして認識される
3. M5Stack S3の画面に "USB HID Keyboard" と表示され、"Ready!" が表示される
4. 画面下部に "USB HID Ready" と緑色で表示されれば準備完了

## 使用方法

USB接続が完了したら、画面下部のタッチエリアを使用します：

- **タッチエリアA（左下）**: "A" が入力される
- **タッチエリアB（中央下）**: "😆" が入力される  
- **タッチエリアC（右下）**: "🍭✒" が入力される

### タッチエリアの位置
```
画面下部（y > 200）を3つのエリアに分割：
┌─────────┬─────────┬─────────┐
│    A    │    B    │    C    │
│ (0-79)  │(80-159) │(160-239)│
└─────────┴─────────┴─────────┘
```

各タッチエリアをタップすると、対応する文字が入力され、画面に視覚的なフィードバックが表示されます。

## 技術仕様

- **プラットフォーム**: ESP32-S3 (M5Stack CoreS3)
- **通信方式**: USB HID (Human Interface Device)
- **ライブラリ**: 
  - M5Unified@^0.1.16
  - Arduino ESP32 USB HID (内蔵)

## BLE版との比較

| 項目 | USB HID版 (S3) | BLE版 (Basic) |
|------|----------------|---------------|
| 接続方式 | USB有線 | Bluetooth無線 |
| 絵文字対応 | ✅ 完全対応 | ❌ 制限あり |
| 遅延 | 極低 | 低〜中 |
| 接続安定性 | 非常に高い | 高い |
| バッテリー消費 | なし（USB給電） | あり |
| 移動性 | 制限あり | 自由 |

## 注意事項

- M5Stack S3をUSBケーブルでPCに接続する必要があります
- 一度に1台のPCにのみ接続可能です
- USB HID機能を使用するため、シリアル通信とキーボード機能が同時に動作します

## トラブルシューティング

### USBキーボードとして認識されない場合
1. M5Stack S3を再起動する
2. USBケーブルを抜き差しする
3. PCのデバイスマネージャーでHIDキーボードデバイスを確認する
4. 別のUSBポートを試す

### 絵文字が正しく入力されない場合
1. 接続先アプリケーションがUnicode文字に対応しているか確認する
2. システムの文字エンコーディング設定を確認する
3. テキストエディタなどのUnicode対応アプリケーションで試す

### 文字が入力されない場合
1. USB接続状態を確認する
2. M5Stack S3の画面で "USB HID Ready" が表示されているか確認する
3. テキスト入力可能なアプリケーションにフォーカスがあるか確認する

## 開発者向け情報

### カスタマイズ方法

絵文字や入力文字を変更したい場合は、`src/main.cpp`の以下の部分を編集してください：

```cpp
// Button B pressed
Keyboard.print("😆");  // ここを変更

// Button C pressed  
Keyboard.print("🍭✒");  // ここを変更
```

### 対応文字

ESP32-S3のUSB HID機能は以下をサポートします：
- ASCII文字
- Unicode文字（絵文字含む）
- 特殊キー（Ctrl、Alt、Shift等の組み合わせ）
- ファンクションキー

## ライセンス

このプロジェクトはオープンソースです。自由に改変・配布してください。
